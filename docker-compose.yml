services:
  keycloak:
    container_name: keycloak
    image: quay.io/keycloak/keycloak:26.5.1
    command:
      - start-dev
      - --import-realm
      - --health-enabled=true
    environment:
      KC_DB: dev-mem
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
      - ./keycloak/themes/pms:/opt/keycloak/themes/pms:ro
    ports:
      - "8080:8080"
    networks:
      - pms-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "cat < /dev/null > /dev/tcp/localhost/9000 2>/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 30s

  pms-client:
    container_name: pms-client
    build:
      context: ./pms-client
      dockerfile: Dockerfile
      args:
        VITE_ENV: ${VITE_ENV}
        VITE_API_URL: ${VITE_API_URL}
        VITE_KEYCLOAK_URL: ${VITE_KEYCLOAK_URL}
        VITE_KEYCLOAK_REALM: ${VITE_KEYCLOAK_REALM}
        VITE_KEYCLOAK_CLIENT_ID: ${VITE_KEYCLOAK_CLIENT_ID}
    ports:
      - "2407:2407"
    networks:
      - pms-network
    env_file:
      - .env
    depends_on:
      keycloak:
        condition: service_healthy
    restart: unless-stopped

networks:
  pms-network:
    driver: bridge
