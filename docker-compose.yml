services:
  keycloak-postgres:
    container_name: keycloak-postgres
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - keycloak-postgres-data:/var/lib/postgresql/data
    networks:
      - pms-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
      interval: 5s
      timeout: 5s
      retries: 10

  keycloak:
    container_name: keycloak
    image: quay.io/keycloak/keycloak:26.5.1
    command:
      - start
      - --import-realm
      - --health-enabled=true
      - --hostname-strict=false
      - --http-enabled=true
    environment:
      # Database
      KC_DB: ${KC_DB}
      KC_DB_URL: ${KC_DB_URL}
      KC_DB_USERNAME: ${KC_DB_USERNAME}
      KC_DB_PASSWORD: ${KC_DB_PASSWORD}
      # Admin credentials
      KC_BOOTSTRAP_ADMIN_USERNAME: ${KC_BOOTSTRAP_ADMIN_USERNAME}
      KC_BOOTSTRAP_ADMIN_PASSWORD: ${KC_BOOTSTRAP_ADMIN_PASSWORD}
      # Hostname
      KC_HOSTNAME: ${KC_HOSTNAME}
      KC_PROXY_HEADERS: ${KC_PROXY_HEADERS}
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
      - ./keycloak/themes/pms:/opt/keycloak/themes/pms:ro
    ports:
      - "8080:8080"
    networks:
      - pms-network
    env_file:
      - .env
    depends_on:
      keycloak-postgres:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "cat < /dev/null > /dev/tcp/localhost/9000 2>/dev/null"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 60s

  admin-service:
    container_name: admin-service
    build:
      context: ./pms-server/admin-service
      dockerfile: Dockerfile
      args:
        PORT: ${ADMIN_SERVICE_PORT}
        ENV: ${ADMIN_SERVICE_ENV}
        PUBLICKEY: ${ADMIN_SERVICE_PUBLICKEY}
        LOG_LEVEL: ${ADMIN_SERVICE_LOG_LEVEL}
    ports:
      - "${ADMIN_SERVICE_PORT}:${ADMIN_SERVICE_PORT}"
    networks:
      - pms-network
    env_file:
      - .env
    depends_on:
      keycloak:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${ADMIN_SERVICE_PORT}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  management-service:
    container_name: management-service
    build:
      context: ./pms-server/management-service
      dockerfile: Dockerfile
      args:
        PORT: ${MANAGEMENT_SERVICE_PORT}
        ENV: ${MANAGEMENT_SERVICE_ENV}
        PUBLICKEY: ${MANAGEMENT_SERVICE_PUBLICKEY}
        LOG_LEVEL: ${MANAGEMENT_SERVICE_LOG_LEVEL}
    ports:
      - "${MANAGEMENT_SERVICE_PORT}:${MANAGEMENT_SERVICE_PORT}"
    networks:
      - pms-network
    env_file:
      - .env
    depends_on:
      keycloak:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${MANAGEMENT_SERVICE_PORT}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  pms-client:
    container_name: pms-client
    build:
      context: ./pms-client
      dockerfile: Dockerfile
      args:
        VITE_ENV: ${VITE_ENV}
        VITE_API_URL: ${VITE_API_URL}
        VITE_KEYCLOAK_URL: ${VITE_KEYCLOAK_URL}
        VITE_KEYCLOAK_REALM: ${VITE_KEYCLOAK_REALM}
        VITE_KEYCLOAK_CLIENT_ID: ${VITE_KEYCLOAK_CLIENT_ID}
    ports:
      - "2407:2407"
    networks:
      - pms-network
    env_file:
      - .env
    depends_on:
      keycloak:
        condition: service_healthy
      admin-service:
        condition: service_healthy
      management-service:
        condition: service_healthy
    restart: unless-stopped

networks:
  pms-network:
    driver: bridge

volumes:
  keycloak-postgres-data:
    external: true
